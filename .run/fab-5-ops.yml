name: fab-5-ops

labels:
  team: destinations
  owner: epd-destinations@segment.com
  github_repo: https://github.com/segmentio/fab-5-engine
  Autoscale::Target::CPU: 80
  Autoscale::Target::Mem: 70

container:
  image: fab-5-engine
  repository: 528451384384.dkr.ecr.us-west-2.amazonaws.com
  cmd: ["./scripts/run.sh"]

expose:
  - name: http
    port: 3000
    proto: http
    health_check_path: /health
    health_check_status: 204

resources:
  cpu_shares: 512
  mem_mb: 512

count:
  production:
    min: 1
    max: 3
    autoscale_policy: cpu_mem_tracking
  stage:
    min: 1
    max: 3
    autoscale_policy: cpu_mem_tracking

autodeploy:
  production:
    branch: master
  stage:
    branch: staging

security-groups:
  from-config:
    - "DEFAULT_SECURITY_GROUP"
    - "CONTROL_PLANE_CROSS_REGION"

config-providers:
  - name: "tfe-stage"
    type: "terraform"
    options:
      environment: "segment-infra/stage"
  - name: "tfe-prod"
    type: "terraform"
    options:
      environment: "segment/production"

config:
  production:
    AWS_REGION: us-west-2
    NODE_ENV: production
    PORT: 3000
    UV_THREADPOOL_SIZE: 128
    DATADOG_AGENT_ADDR: "172.17.42.1:8125"
    SENTRY_DSN: https://e1f53320787f46a28883db55c7e73c71@o19879.ingest.sentry.io/5510102
    STATS_PREFIX: fab-5-ops
    DEFAULT_SECURITY_GROUP:
      provider: "tfe-prod"
      key: "security_groups"
    CONTROL_PLANE_CROSS_REGION: "sg-0d4dfca64523eb4b1"

  stage: &stage_config
    AWS_REGION: us-west-2
    NODE_ENV: stage
    PORT: 3000
    UV_THREADPOOL_SIZE: 128
    DATADOG_AGENT_ADDR: "172.17.42.1:8125"
    SENTRY_DSN: https://e1f53320787f46a28883db55c7e73c71@o19879.ingest.sentry.io/5510102
    STATS_PREFIX: fab-5-ops
    CONTROL_PLANE_CROSS_REGION: "sg-0f5db0fed73ba7910"
    DEFAULT_SECURITY_GROUP:
      provider: "tfe-stage"
      key: "security_groups"

  dev:
    <<: *stage_config
